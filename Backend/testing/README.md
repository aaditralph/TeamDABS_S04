# Genesis Backend - Testing Suite

Complete testing suite for the Genesis waste management backend system.

## Contents

```
testing/
├── README.md                    # This file
├── TESTING.md                   # Comprehensive testing guide
├── postman/
│   └── genesis-backend.postman-collection.json   # Postman collection
├── hoppscotch/
│   └── genesis-backend-hoppscotch.json          # Hoppscotch collection
├── scripts/
│   ├── seed-test-data.sh       # Seed test data
│   ├── test-all.sh             # Complete automated test suite
│   └── test-workflows.sh       # Workflow-specific tests
└── sample-data/
    └── (generated by seed script)
```

## Quick Start

### 1. Start MongoDB and Server

```bash
cd /home/aaditralph/Desktop/Hackathon/Genesis/Backend
docker-compose up -d
bun run dev
```

### 2. Seed Test Data

```bash
cd testing/scripts
chmod +x seed-test-data.sh
./seed-test-data.sh
```

This creates:
- 5 societies (Green Valley, Sunshine Heights, etc.)
- 3 BMC officers
- 3 residents
- 2 customers
- Multiple verification reports

### 3. Run Automated Tests

```bash
chmod +x test-all.sh
./test-all.sh
```

### 4. Run Workflow Tests

```bash
chmod +x test-workflows.sh
./test-workflows.sh approval      # Test approval workflow
./test-workflows.sh verification  # Test verification workflow
./test-workflows.sh leaderboard  # Test leaderboard
./test-workflows.sh bmc          # Test BMC dashboard
./test-workflows.sh all          # Run all workflows
```

## Postman Collection

### Import Instructions

1. Open Postman
2. Click **Import** → Select `postman/genesis-backend.postman-collection.json`
3. Create environment with variables:
   - `baseUrl`: `http://localhost:3000`
   - `adminToken`: (will be set by login requests)
   - `officerToken`: (will be set by login requests)
   - `societyToken`: (will be set by login requests)
   - `residentToken`: (will be set by login requests)
   - `customerToken`: (will be set by login requests)

### Collection Structure

- **0. Health & Setup** - Server health check
- **1. Admin Authentication** - Admin login and management
- **2. BMC Officer Auth** - Officer registration and login
- **3. BMC Dashboard** - Officer dashboard and reviews
- **4. Society Worker** - Society registration and management
- **5. Verification System** - Report submission and AI detection
- **6. Resident** - Resident registration and profile
- **7. Customer** - Customer registration and profile
- **8. Public APIs** - No-auth required endpoints (leaderboard, etc.)
- **9. Complete Workflows** - End-to-end workflows

## Hoppscotch Collection

### Import Instructions

1. Open [Hoppscotch](https://hoppscotch.io)
2. Click **Import Collection** → Select `hoppscotch/genesis-backend-hoppscotch.json`
3. Set environment variables (baseUrl, tokens, IDs)

## Test Credentials

| Role | Email | Password |
|------|-------|----------|
| Admin | DABS | 123 |
| Officer 1 | officer1@bmc.gov.in | password123 |
| Officer 2 | officer2@bmc.gov.in | password123 |
| Officer 3 | officer3@bmc.gov.in | password123 |
| Society 1 | manager@greenvalley.in | password123 |
| Society 2 | manager@sunshine.in | password123 |
| Resident 1 | alice@greenvalley.in | password123 |
| Resident 2 | bob@greenvalley.in | password123 |
| Customer 1 | david@email.com | password123 |
| Customer 2 | eve@email.com | password123 |

## Manual Testing

### Health Check

```bash
curl http://localhost:3000/health
```

### Admin Login

```bash
curl -X POST http://localhost:3000/admin/login \
  -H "Content-Type: application/json" \
  -d '{"email":"DABS","password":"123"}'
```

### Officer Registration

```bash
curl -X POST http://localhost:3000/api/officer/register \
  -F "name=John" \
  -F "email=john@bmc.gov.in" \
  -F "password=pass123" \
  -F "phone=9876543210" \
  -F "documentType=Aadhar" \
  -F "document=@test-doc.pdf"
```

### Verification Report

```bash
curl -X POST http://localhost:3000/api/verification/report/upload \
  -H "Authorization: Bearer $TOKEN" \
  -F "societyAccountId=$ACCOUNT_ID" \
  -F "meter_image=@meter.jpg" \
  -F "composter_image=@composter.jpg"
```

### Leaderboard

```bash
curl http://localhost:3000/api/resident/leaderboard
curl http://localhost:3000/api/resident/leaderboard/top/5
curl http://localhost:3000/api/resident/leaderboard/society/Green%20Valley
```

## Test Coverage

### Authentication Tests
- ✅ Admin login (DABS)
- ✅ Officer registration with document upload
- ✅ Officer approval workflow
- ✅ Officer login
- ✅ Society registration and approval
- ✅ Society login
- ✅ Resident registration and login
- ✅ Customer registration and login

### Verification Tests
- ✅ Report submission with images
- ✅ AI verification processing
- ✅ Report status updates
- ✅ Tax rebate calculation
- ✅ Report retrieval

### BMC Dashboard Tests
- ✅ Pending reviews
- ✅ Officer review (approve/reject)
- ✅ Dashboard statistics
- ✅ Notifications

### Public API Tests
- ✅ Society listing
- ✅ Society details
- ✅ Society reports
- ✅ Tax rebates
- ✅ Leaderboard
- ✅ Top N societies
- ✅ Society rank

## Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| Login fails 403 | Account needs admin approval |
| File upload fails | Check `uploads/` directory exists |
| MongoDB not connected | Run `docker-compose up -d` |
| Port in use | Kill process on port 3000 |
| Token expired | Re-login to get new token |

### Debug Commands

```bash
# Check MongoDB
docker-compose ps

# Check server status
curl http://localhost:3000/health

# Check uploads directory
ls -la uploads/

# Check environment
cat .env
```

## Automated Test Output

```
========================================
Genesis Backend - Automated Test Suite
========================================

Starting test suite at 2026-02-07 00:00:00
Base URL: http://localhost:3000

========================================
1. Health Check
========================================

✓ Health check passed
...
========================================
Test Summary
========================================

Total Tests: 50
Passed: 48
Failed: 2

All tests passed! ✓
```

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: docker-compose up -d
      - run: sleep 5
      - run: cd testing/scripts && chmod +x *.sh && ./seed-test-data.sh
      - run: ./test-all.sh
```

## Support

For issues and questions:
- Check [TESTING.md](../TESTING.md) for detailed documentation
- Check [AGENTS.md](../AGENTS.md) for development guidelines
- Review API responses for error messages
